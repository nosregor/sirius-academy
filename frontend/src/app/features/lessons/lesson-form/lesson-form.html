<mat-card>
  <mat-card-header>
    <mat-card-title>New Lesson</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    @if (isLoading()) {
      <app-loading-spinner message="Loading..."></app-loading-spinner>
    } @else {
      <form [formGroup]="lessonForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <mat-form-field class="full-width">
            <mat-label>Teacher</mat-label>
            <mat-select formControlName="teacherId">
              @for (teacher of teachers(); track teacher.id) {
                <mat-option [value]="teacher.id">
                  {{ teacher.firstName }} {{ teacher.lastName }} - {{ teacher.instrument }}
                </mat-option>
              }
            </mat-select>
            @if (getErrorMessage('teacherId')) {
              <mat-error>{{ getErrorMessage('teacherId') }}</mat-error>
            }
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-label>Student</mat-label>
            <mat-select formControlName="studentId">
              @for (student of filteredStudents(); track student.id) {
                <mat-option [value]="student.id">
                  {{ student.firstName }} {{ student.lastName }} - {{ student.instrument }}
                </mat-option>
              }
            </mat-select>
            @if (getErrorMessage('studentId')) {
              <mat-error>{{ getErrorMessage('studentId') }}</mat-error>
            }
            @if (selectedTeacherId() && filteredStudents().length === 0) {
              <mat-hint class="warning-hint">No students assigned to this teacher</mat-hint>
            } @else if (selectedTeacherId()) {
              <mat-hint>Only showing students assigned to this teacher</mat-hint>
            } @else {
              <mat-hint>Select a teacher first</mat-hint>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field class="full-width">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" [min]="minDate" formControlName="startDate" />
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            @if (getErrorMessage('startDate')) {
              <mat-error>{{ getErrorMessage('startDate') }}</mat-error>
            }
            <mat-hint>Select a date from today onwards</mat-hint>
          </mat-form-field>

          <div class="time-picker-row">
            <mat-form-field class="time-picker-field">
              <mat-label>Hour</mat-label>
              <mat-select formControlName="startHour">
                @for (hour of hourOptions; track hour.value) {
                  <mat-option [value]="hour.value">{{ hour.label }}</mat-option>
                }
              </mat-select>
              @if (getErrorMessage('startHour')) {
                <mat-error>{{ getErrorMessage('startHour') }}</mat-error>
              }
            </mat-form-field>

            <span class="time-separator">:</span>

            <mat-form-field class="time-picker-field">
              <mat-label>Minute</mat-label>
              <mat-select formControlName="startMinute">
                @for (minute of minuteOptions; track minute.value) {
                  <mat-option [value]="minute.value">{{ minute.label }}</mat-option>
                }
              </mat-select>
              @if (getErrorMessage('startMinute')) {
                <mat-error>{{ getErrorMessage('startMinute') }}</mat-error>
              }
              <mat-hint>Time must be in 15-minute intervals</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="form-row">
          <mat-form-field class="full-width">
            <mat-label>Duration (minutes)</mat-label>
            <input matInput type="number" formControlName="duration" min="15" max="240" step="15" />
            @if (getErrorMessage('duration')) {
              <mat-error>{{ getErrorMessage('duration') }}</mat-error>
            }
            <mat-hint>Between 15 and 240 minutes (15min increments)</mat-hint>
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-label>Initial Status</mat-label>
            <mat-select formControlName="creatorRole">
              @for (option of initialStatusOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
            @if (getErrorMessage('creatorRole')) {
              <mat-error>{{ getErrorMessage('creatorRole') }}</mat-error>
            }
            <mat-hint
              >Choose whether the lesson should be confirmed immediately or pending
              confirmation</mat-hint
            >
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-button type="button" (click)="onCancel()" [disabled]="isSaving()">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="isSaving()">
            {{ isSaving() ? 'Creating...' : 'Create Lesson' }}
          </button>
        </div>
      </form>
    }
  </mat-card-content>
</mat-card>
